
## Exercise 1: Continuous Integration

Duration: 40 minutes

After a requirements gathering effort, we find that Fabrikam Medical Conferences has many areas of potential improvement in their development workflow.  Specifically, we conclude that there are a lot of manual tasks that can be automated. Automation potentially mitigates many of the recurring quality and security issues. Also, the dependencies between Fabrikam's developers' work and productivity are reduced. We will begin to address some of these efforts in this exercise to improve developer flow and establish continuous integration practices.

### Task 1: Set up Local Infrastructure

   > **Note**: Make sure the Docker Desktop is in Running state as shown in the below screenshot, If not close Docker Desktop from the Task Bar/Task Manager. Then Re-start Docker Desktop from Desktop and wait for 2-5 mins to Docker Desktop get Started.
   
   ![The Docker Desktop Status before performing the task.](media/Docker-Desktop-Status.png "Docker Desktop Status")

1. In your Labvm navigate to `C:\Workspaces\lab\mcw-continuous-delivery-lab-files` open **docker-compose.init.yml** and replace instances of `<yourgithubaccount>` with your GitHub account name.

    ![](media/imageupdate.png)
    
1. Similarly in the same path open **docker-compose.yml** and replace instances of `<yourgithubaccount>` with your GitHub account name.

   ![](media/imageupdate2.png)

4. Now navigate back to the PowerShell window to build and run the docker-compose YAML files edited in the previous step by running the following command. After 15-20 mins, proceed with the next step to check if you are able to see the website.

    ```pwsh
    docker-compose -f .\docker-compose.yml -f .\local.docker-compose.yml -f .\docker-compose.init.yml build
    docker-compose -f .\docker-compose.yml -f .\local.docker-compose.yml -f .\docker-compose.init.yml up
    ```
    
    > **Note**: If you face an issue while running the above command with respect to GitHub username, update username in lowercase letter and retry the command. 
    
    > If you face an issue while running above command with respect to default daemon configuration, open docker desktop and click on **Troubleshoot icon** at the right corner and select **Restart** to restart the docker desktop. It might take upto 5 minutes for restarting and rerun the command once restart is completed.
      
      ![Docker restart.](media/Dockerrestart.png "Docker Desktop restart")
      
5. Verify that you can browse to http://localhost:3000 in a browser and arrive at the Fabrikam conference website.

   ![Fabrikam Medical's Contoso conference site.](media/hol-ex1-task3-step3-1.png "Contoso conference site")

   ![The docker-compose log output observed when running `docker-compose up` on our docker-compose harness.](media/hol-ex1-task3-step3-2.png "docker-compose log output")

6. Leave this PowerShell session in running and open a new session. Paste the following command and hit `<ENTER>`.

    ```pwsh
    cd C:\Workspaces\lab\mcw-continuous-delivery-lab-files
    ```

7. Commit and push your changes to your GitHub repository by running the following commands.

   ```
   git add .
   git commit -m "pushing changes"
   git push
   ```
   ![The docker-compose log output observed when running `docker-compose up` on our docker-compose harness.](media/up-ex1-task3-step3-5.png "docker-compose log output")
 

### Task 2: Build Automation with GitHub Registry

1.  Now navigate back to your GitHub and select the **Settings** tab from your lab files repository.

    ![](media/click%20settings.png)

2. Under **Security**, expand **Secrets(1)** by clicking the drop-down and select **Actions(2)** blade from the left navigation bar.

    ![](media/seret.png)

3. On **Action Secrets** tab, select the **New repository secret** button.

    ![The GitHub Repository Secrets we will create a new repository secret here used in a later step.](media/newreposecret.png "GitHub Repository Secrets")
    
4. Under **Actions Secrets/New secret** page, enter the below mentioned details:

     - **Name** : Enter **GITHUB_TOKEN (1)**

     - **Value** : Enter the **GitHub Personal Access Token (2)** you created in the Before the Hands-On Lab instructions.

     - Click on **Add secret (3)**

     ![The New secret form where we create the `CR_PAT` secret.](media/newsecrete.png "New secret form")

5. Select the `Actions` tab in your GitHub repository, under the **Continuous Integration Workflows** find the **Publish Docker Container** workflow and choose **Configure**.

    ![](media/e1t4s5.1.png "Publish Docker Container workflow")

6. Rename or ensure the name of the file to `docker-publish.yml`.

7. Copy contents from the local file `docker-publish.yml` which can be found on the  `C:\Workspaces\lab\mcw-continuous-delivery-lab-files\` folder on the lab VM.

8. Commit the file to the repository by clicking on **Start commit (1)** and then **Commit new file (2)**.

    ![](media/commitnewfile.png "GitHub Packages")

    - This file builds the following workflow:
  ![GitHub workflow with 4 jobs - Check modified files, Update the API Docker image, Update the Init Docker image, Update the Web Docker image. This example shows a commit updating the Init and Web APIs. The workflow shows Update the API Docker image skipped, while Update the Init Docker image and Update the Web Docker image are in progress.](media/github-actions-workflow-with-skip.png)
    - The `check_changed_folders` job takes the following steps:

      1. Look through all files in the `git diff`.
      2. If there are files changed in `content-api`, set a flag to update the API Docker Image.
      3. If there are files changed in `content-web`, set a flag to update the Web Docker Image.
      4. If there are files changed in `content-init`, set a flag to update the Init Docker Image.
  
    - Each of the `build-` jobs are marked with `needs` to depend on the `git diff` check. The `if` indicates the condition that will trigger that job to run.

9. Cpull your changes to your GitHub repository by running the following commands.

   ```
   git pull
   ```

    > **Note**: You can optionally add `workflow_dispatch:` in the `on:` trigger section to set a manual trigger for the GitHub Actions workflow.

    > **Note**: If you encounter any errors due to `cosign`, feel free to remove the image signing section from the workflow, as it is not needed to complete the lab. You could alternatively add a manual trigger (see above) and try running the workflow again, to determine if the error is transient.

16. Navigate to the `Packages` tab in your GitHub account and verify that the container images have been built and pushed to the container registry.

    ![GitHub Packages tab listing summary of container images that have been pushed to the container registry.](media/hol-ex1-task4-step12-1.png "GitHub Packages")


28. Pull the latest changes from your GitHub repository.

    ```
    git pull
    ```
   

### Task 3: Using Dependabot

1. Previously we enabled Dependabot features. To observe these Dependabot issues, navigate to the `Security` tab and select the `View Dependabot alerts` link. You should arrive at the `Dependabot alerts` blade in the `Security` tab.

    ![GitHub Dependabot alerts in the Security tab.](media/hol-ex1-task2-step3-1.png "GitHub Dependabot alerts")

1. Sort the Dependabot alerts by `Package name`. Locate the `handlebars` vulnerability by typing `handlebars` in the search box under the `Package` dropdown menu. 

    ![Summary of the `handlebars` Dependabot alert in the list of Dependabot alerts.](media/search-handlebars.png "`handlebars` Dependabot alert")

1. Select any of the `handlebars` Dependabot alert entries to see the alert detail. After reviewing the alert, select `Create Dependabot security update` and wait a few moments for GitHub to create the security update.

    ![The `handlebars` Dependabot alert detail.](media/create-dependabot-security.png "Dependabot alert detail")

    ![The Dependabot security update message observed when creating a Dependabot security update.](media/running-security-update.png "Dependabot security update message")

1. In the `Pull Requests` tab, find the Dependabot security patch pull request and merge it to your main branch.

    ![List of Pull Requests.](media/hol-ex1-task2-step6-1.png "Pull Requests")

    ![The Pull Request Merge Button in the Pull Request detail.](media/hol-ex1-task2-step6-2.png "Pull Request Merge Button")

1. Pull the latest changes from your GitHub repository to your local GitHub folder.

    ```pwsh
    cd C:\Workspaces\lab\mcw-continuous-delivery-lab-files  # This path may vary depending on how
                                                            # you set up your lab files repository
    git pull
    ```